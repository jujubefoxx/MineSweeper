<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Title</title>
    <link rel="stylesheet/less" href="/static/index.less">
    <script src="//cdnjs.cloudflare.com/ajax/libs/less.js/2.5.3/less.min.js"></script>
</head>
<body>
<div id="mineSweeper">
    <div class="board">
        <div v-for="(row,index) in board" class="board-row">
            <div v-for="(column,key) in row" class="board-column"
                 @click="isSetFlag ? setFlag([index,key], column.data) : isInit ? updateBoard([index,key]) : setBoom([index,key])">
                <div v-if="parseInt(column.data) === -1" class="board-column__unknown"></div>
                <div v-else-if="column.data === 'X'" class="board-column__show">
                    <img class="board-column__img" src="static/images/icon_boom1.svg">
                </div>
                <img v-else-if="column.data === 'F'" class="board-column__img" src="static/images/flag.svg">
                <div v-else class="board-column__show">{{ parseInt(column.data) > 0 ? column.data : '' }}</div>
            </div>
        </div>
    </div>

    <div class="bottom">
        <div class="bottom-button">
            <div class="bottom-button__list bottom-button__restart" @click="restart">重新开始</div>
            <div :class="['bottom-button__list bottom-button__flag',isSetFlag ? 'bottom-button__flag--active':'']"
                 @click="isSetFlag = !isSetFlag">
                插旗
            </div>

        </div>
        <div v-if="over" class="bottom-tips">踩到地雷，游戏结束！</div>
    </div>
</div>
<!--&lt;!&ndash;引入cdn&ndash;&gt;-->
<!--<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>-->
<script src="utils/vue.js"></script>

<script>
    const el = new Vue({
            //挂载
            el: "#mineSweeper",
            data() {
                const board = new Array(9).fill(new Array(9).fill({
                    data: '-1',//显示的值 -1未翻开 0翻开的空格子 数字1-9附近有炸弹 X炸弹 F旗帜(旗帜代表未翻开，但不能点击)
                    show: false,//是否翻开
                    isBoom: false //是否炸弹
                }))
                return {
                    isInit: false, // 保证第一个点击的格子不是雷
                    board,
                    over: false, // 游戏是否结束
                    isSetFlag: false,// 是否插旗状态
                }
            },
            methods: {
                //插旗
                setFlag(click, data) {
                    const {board} = this;
                    const [cX, cY] = click;
                    const obj = {
                        data: 'F',// F旗帜
                        show: false,// 未翻开
                        isBoom: false // 不是炸弹
                    };
                    if (data === 'F') {
                        obj.data = '-1'; // 未翻开
                    }
                    this.editBoard(cX, cY, obj);
                },
                // 重新开始
                restart() {
                    this.board = new Array(9).fill(new Array(9).fill({
                        data: '-1',
                        show: false,
                        isBoom: false
                    }));
                    this.isInit = false;
                    this.over = false;
                },
                // 修改数组
                editBoard(x, y, data) {
                    const {board} = this;
                    const row = [...board[x]];// 获取那一行的数据
                    row.splice(y, 1, data) // 修改
                    this.$set(board, x, row)
                },
                // 初始化棋盘
                setBoom(click) {
                    const {board} = this;
                    const [cX, cY] = click;
                    const dx = [], dy = [];
                    //先生成十个炸弹
                    while (dx.length < 10) {
                        const randomX = Math.round(Math.random() * (board.length - 1));//获取一个范围内的随机数
                        const randomY = Math.round(Math.random() * (board.length - 1));//获取一个范围内的随机数
                        const isClick = JSON.stringify([cX, cY]) === JSON.stringify([randomX, randomY])
                        if (!isClick && (dx.indexOf(randomX) === -1 || dx.indexOf(randomX) !== dy.indexOf(randomY))) {
                            // 如果没有重复则推入
                            dx.push(randomX)
                            dy.push(randomY)
                        }
                    }

                    // 修改炸弹数据
                    for (let i = 0; i < dx.length; i++) {
                        // console.log(JSON.stringify([dx[i]][dy[i]]))
                        const obj = {
                            data: '-1',
                            show: false,
                            isBoom: true //是炸弹
                        }
                        this.editBoard(dx[i], dy[i], obj);
                    }
                    this.isInit = true;
                    this.updateBoard(click);
                },
                // 更新格子状态
                updateBoard(click) {
                    const {board, over} = this;
                    if (over) return;// 如果游戏已经结束 直接返回
                    const m = board.length;
                    const n = board[0].length;
                    const dx = [1, -1, 0, 0, -1, 1, -1, 1]; // 横坐标
                    const dy = [0, 0, 1, -1, 1, -1, -1, 1]; // 纵坐标
                    const inBound = (x, y) => x >= 0 && x < m && y >= 0 && y < n; // 辅助函数

                    const update = (x, y) => {
                        if (!inBound(x, y) || board[x][y].show || board[x][y].data === 'F') return; // 不在界内或已翻开，直接返回
                        let count = 0;
                        for (let i = 0; i < 8; i++) { // 统计周围雷的个数
                            const nX = x + dx[i];
                            const nY = y + dy[i];
                            if (inBound(nX, nY) && board[nX][nY].isBoom) {
                                count++;
                            }
                        }
                        if (count === 0) { // 如果周围没有雷，翻开且标记0，递归上下左右的点
                            const obj = {
                                data: '0',// 0翻开的空格子
                                show: true,// 已翻开
                                isBoom: false // 不是炸弹
                            }
                            this.editBoard(x, y, obj)
                            for (let i = 0; i < 4; i++) {
                                update(x + dx[i], y + dy[i]);// 只递归前四个点
                            }
                        } else {
                            const obj = {
                                data: count + '',// 数字1-9附近有炸弹
                                show: true,// 已翻开
                                isBoom: false // 不是炸弹
                            }
                            this.editBoard(x, y, obj)
                        }
                    };

                    const [cX, cY] = click;
                    if (board[cX][cY].isBoom) { // 第一下就踩雷了
                        const obj = {
                            data: 'X',// X炸弹
                            show: true,// 已翻开
                            isBoom: true // 是炸弹
                        };
                        this.editBoard(cX, cY, obj);
                        this.over = true;
                    } else {
                        update(cX, cY); // 开启dfs
                    }
                }
            }
        })
    ;
</script>
</body>
</html>
